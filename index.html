<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Detecci√≥n de Articulaciones - MediaPipe FUNCIONA</title>
        <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #121212;
            color: white;
            font-family: Arial, sans-serif;
            flex-direction: column;
            padding: 10px;
        }
        
        .container {
            position: relative;
            max-width: 640px;
            width: 100%;
            text-align: center;
        }
        
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            transform: scaleX(-1); /* Espejo para c√°mara frontal */
        }
        
        #video { 
            display: block;
            opacity: 0.7;
        }
        
        #canvas {
            z-index: 2;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #4CAF50;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 10;
            border: 2px solid #4CAF50;
        }
        
        .controls {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:hover { 
            background: #45a049;
            transform: scale(1.05);
        }
        
        .stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 5;
            border-left: 3px solid #4CAF50;
        }
        
        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            text-align: left;
            max-width: 640px;
        }
    </style>

        <!-- MediaPipe Pose - ¬°ESTE S√ç FUNCIONA! -->
        <script
            src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675986977/pose.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1676469567/camera_utils.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1676469614/drawing_utils.js"></script>
    </head>
    <body>
        <h1>üéØ Detector de Articulaciones en Tiempo Real</h1>

        <div class="container">
            <div id="loading">Inicializando MediaPipe Pose...</div>
            <div class="stats" id="stats" style="display: none;">
                Puntos detectados: <span id="points">0</span> |
                Confianza: <span id="confidence">0%</span>
            </div>

            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>

            <div class="controls">
                <button id="start-btn">‚ñ∂Ô∏è Iniciar Detecci√≥n</button>
                <button id="toggle-skeleton">ü¶¥ Esqueleto: ON</button>
                <button id="toggle-landmarks">üî¥ Puntos: ON</button>
                <button id="change-camera">üì∑ Cambiar C√°mara</button>
            </div>
        </div>

        <div class="info">
            <strong>Instrucciones:</strong>
            <ol>
                <li>Haz clic en "Iniciar Detecci√≥n"</li>
                <li>Permite el acceso a la c√°mara cuando te lo pida</li>
                <li>Usa los botones para mostrar/ocultar elementos</li>
                <li>¬°Mueve tu cuerpo y ve c√≥mo detecta las articulaciones!</li>
            </ol>
            <p><strong>Nota:</strong> Esta versi√≥n usa MediaPipe de Google, que
                funciona en todos los navegadores modernos.</p>
        </div>

        <script>
        // ========== CONFIGURACI√ìN ==========
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loading = document.getElementById('loading');
        const stats = document.getElementById('stats');
        const pointsSpan = document.getElementById('points');
        const confidenceSpan = document.getElementById('confidence');
        
        let pose = null;
        let camera = null;
        let isRunning = false;
        let showSkeleton = true;
        let showLandmarks = true;
        let currentFacingMode = 'user'; // 'user' = frontal, 'environment' = trasera
        
        // ========== INICIALIZAR MEDIAPIPE POSE ==========
        async function initializePose() {
            try {
                loading.textContent = "Cargando MediaPipe Pose...";
                
                // Crear instancia de Pose
                pose = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675986977/${file}`;
                    }
                });
                
                // Configurar opciones
                pose.setOptions({
                    modelComplexity: 1, // 0=light, 1=full, 2=heavy
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                // Conectar los resultados a nuestra funci√≥n de dibujo
                pose.onResults(onPoseResults);
                
                loading.textContent = "MediaPipe cargado. Iniciando c√°mara...";
                console.log("‚úÖ MediaPipe Pose inicializado correctamente");
                
                return true;
            } catch (error) {
                console.error("Error inicializando MediaPipe:", error);
                loading.innerHTML = `
                    ‚ùå Error cargando MediaPipe:<br>
                    ${error.message}<br><br>
                    <strong>Soluciones:</strong><br>
                    1. Aseg√∫rate de estar conectado a internet<br>
                    2. Intenta recargar la p√°gina (F5)<br>
                    3. Usa Chrome o Edge
                `;
                return false;
            }
        }
        
        // ========== CONFIGURAR C√ÅMARA ==========
        async function setupCamera() {
            try {
                loading.textContent = "Configurando c√°mara...";
                
                // Obtener lista de c√°maras disponibles
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log(`üì∑ C√°maras disponibles: ${videoDevices.length}`);
                
                // Configurar constraints seg√∫n la c√°mara seleccionada
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    }
                };
                
                // Obtener stream de video
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                
                // Esperar a que el video est√© listo
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        // Configurar canvas al mismo tama√±o que el video
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                        console.log(`üìê Tama√±o del video: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                        resolve();
                    };
                });
                
                // Crear c√°mara de MediaPipe
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        if (isRunning && pose) {
                            await pose.send({image: videoElement});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                console.log("‚úÖ C√°mara configurada correctamente");
                return true;
                
            } catch (error) {
                console.error("Error configurando c√°mara:", error);
                loading.innerHTML = `
                    ‚ùå Error con la c√°mara:<br>
                    ${error.message}<br><br>
                    <strong>Aseg√∫rate de:</strong><br>
                    1. Dar permisos de c√°mara al navegador<br>
                    2. Tener una c√°mara conectada<br>
                    3. No tener otra aplicaci√≥n usando la c√°mara
                `;
                return false;
            }
        }
        
        // ========== MANEJAR RESULTADOS DE POSE ==========
        function onPoseResults(results) {
            if (!isRunning) return;
            
            // Dibujar el video de fondo
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.scale(-1, 1); // Espejo horizontal
            canvasCtx.drawImage(
                results.image, 
                -canvasElement.width, 0, 
                canvasElement.width, canvasElement.height
            );
            canvasCtx.restore();
            
            // Si hay landmarks (puntos) detectados
            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                
                // Contar landmarks visibles
                const visibleLandmarks = landmarks.filter(lm => lm.visibility > 0.5);
                pointsSpan.textContent = visibleLandmarks.length;
                confidenceSpan.textContent = `${Math.round(results.poseLandmarks[0].visibility * 100)}%`;
                
                // Dibujar puntos si est√° activado
                if (showLandmarks) {
                    drawLandmarks(landmarks);
                }
                
                // Dibujar conexiones si est√° activado
                if (showSkeleton) {
                    drawConnections(landmarks);
                }
            } else {
                pointsSpan.textContent = "0";
                confidenceSpan.textContent = "0%";
            }
        }
        
        // ========== DIBUJAR PUNTOS DE ARTICULACIONES ==========
        function drawLandmarks(landmarks) {
            canvasCtx.save();
            canvasCtx.scale(-1, 1); // Compensar el espejo
            
            landmarks.forEach((landmark, index) => {
                if (landmark.visibility > 0.5) {
                    const x = -landmark.x * canvasElement.width;
                    const y = landmark.y * canvasElement.height;
                    
                    // Tama√±o basado en la visibilidad
                    const radius = 4 + (landmark.visibility * 4);
                    
                    // Color basado en la confianza
                    const colorValue = Math.floor(landmark.visibility * 255);
                    
                    // Punto exterior
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, radius + 2, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    canvasCtx.fill();
                    
                    // Punto interior con color
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = `rgb(255, ${255 - colorValue}, 0)`;
                    canvasCtx.fill();
                    
                    // N√∫mero de punto (opcional)
                    // canvasCtx.fillStyle = 'white';
                    // canvasCtx.font = '10px Arial';
                    // canvasCtx.fillText(index, x + 8, y - 8);
                }
            });
            
            canvasCtx.restore();
        }
        
        // ========== DIBUJAR CONEXIONES (ESQUELETO) ==========
        function drawConnections(landmarks) {
            canvasCtx.save();
            canvasCtx.scale(-1, 1);
            
            // Definir las conexiones del cuerpo
            const connections = [
                // Cara y hombros
                [0, 1], [0, 4], [1, 2], [2, 3], [3, 7], [4, 5], [5, 6], [6, 8],
                // Torso
                [9, 10], [11, 12], [11, 23], [12, 24], [23, 24],
                // Brazo izquierdo
                [11, 13], [13, 15], [15, 17], [15, 19], [15, 21], [17, 19],
                // Brazo derecho
                [12, 14], [14, 16], [16, 18], [16, 20], [16, 22], [18, 20],
                // Pierna izquierda
                [23, 25], [25, 27], [27, 29], [27, 31], [29, 31],
                // Pierna derecha
                [24, 26], [26, 28], [28, 30], [28, 32], [30, 32]
            ];
            
            connections.forEach(([start, end]) => {
                const startLandmark = landmarks[start];
                const endLandmark = landmarks[end];
                
                if (startLandmark && endLandmark && 
                    startLandmark.visibility > 0.3 && endLandmark.visibility > 0.3) {
                    
                    const startX = -startLandmark.x * canvasElement.width;
                    const startY = startLandmark.y * canvasElement.height;
                    const endX = -endLandmark.x * canvasElement.width;
                    const endY = endLandmark.y * canvasElement.height;
                    
                    // Grosor de l√≠nea basado en confianza
                    const avgVisibility = (startLandmark.visibility + endLandmark.visibility) / 2;
                    const lineWidth = 2 + (avgVisibility * 3);
                    
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(startX, startY);
                    canvasCtx.lineTo(endX, endY);
                    canvasCtx.lineWidth = lineWidth;
                    canvasCtx.strokeStyle = `rgba(0, 255, 0, ${0.5 + avgVisibility * 0.5})`;
                    canvasCtx.stroke();
                }
            });
            
            canvasCtx.restore();
        }
        
        // ========== INICIAR/DETENER DETECCI√ìN ==========
        async function startDetection() {
            if (isRunning) return;
            
            try {
                loading.textContent = "Iniciando detecci√≥n...";
                
                if (!pose) {
                    const poseLoaded = await initializePose();
                    if (!poseLoaded) return;
                }
                
                if (!camera) {
                    const cameraLoaded = await setupCamera();
                    if (!cameraLoaded) return;
                }
                
                // Iniciar c√°mara y detecci√≥n
                await camera.start();
                isRunning = true;
                
                // Ocultar loading y mostrar stats
                loading.style.display = 'none';
                stats.style.display = 'block';
                
                console.log("‚úÖ Detecci√≥n iniciada correctamente");
                
            } catch (error) {
                console.error("Error iniciando detecci√≥n:", error);
                loading.textContent = `Error: ${error.message}`;
            }
        }
        
        function stopDetection() {
            if (!isRunning) return;
            
            isRunning = false;
            if (camera) {
                camera.stop();
            }
            
            stats.style.display = 'none';
            loading.style.display = 'block';
            loading.textContent = "Detecci√≥n detenida. Haz clic en 'Iniciar' para comenzar.";
        }
        
        // ========== MANEJADORES DE EVENTOS ==========
        document.getElementById('start-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-btn');
            
            if (!isRunning) {
                await startDetection();
                btn.textContent = '‚è∏Ô∏è Detener Detecci√≥n';
                btn.style.background = '#ff4444';
            } else {
                stopDetection();
                btn.textContent = '‚ñ∂Ô∏è Iniciar Detecci√≥n';
                btn.style.background = '#4CAF50';
            }
        });
        
        document.getElementById('toggle-skeleton').addEventListener('click', function() {
            showSkeleton = !showSkeleton;
            this.textContent = showSkeleton ? 'ü¶¥ Esqueleto: ON' : 'ü¶¥ Esqueleto: OFF';
            this.style.background = showSkeleton ? '#4CAF50' : '#666';
        });
        
        document.getElementById('toggle-landmarks').addEventListener('click', function() {
            showLandmarks = !showLandmarks;
            this.textContent = showLandmarks ? 'üî¥ Puntos: ON' : 'üî¥ Puntos: OFF';
            this.style.background = showLandmarks ? '#4CAF50' : '#666';
        });
        
        document.getElementById('change-camera').addEventListener('click', async function() {
            if (!isRunning) {
                alert("Primero inicia la detecci√≥n para cambiar de c√°mara.");
                return;
            }
            
            // Detener detecci√≥n actual
            stopDetection();
            
            // Cambiar tipo de c√°mara
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            this.textContent = currentFacingMode === 'user' ? 'üì∑ C√°mara Frontal' : 'üì∑ C√°mara Trasera';
            
            // Reiniciar con nueva c√°mara
            await startDetection();
            document.getElementById('start-btn').textContent = '‚è∏Ô∏è Detener Detecci√≥n';
            document.getElementById('start-btn').style.background = '#ff4444';
        });
        
        // ========== INICIALIZACI√ìN AUTOM√ÅTICA ==========
        // Cargar MediaPipe al inicio (pero no iniciar c√°mara todav√≠a)
        window.addEventListener('load', async () => {
            try {
                await initializePose();
                loading.textContent = "‚úÖ MediaPipe cargado. Haz clic en 'Iniciar Detecci√≥n' para comenzar.";
                
                // Habilitar el bot√≥n de inicio
                document.getElementById('start-btn').disabled = false;
                
            } catch (error) {
                loading.innerHTML = `
                    ‚ùå No se pudo cargar MediaPipe.<br>
                    Error: ${error.message}<br><br>
                    <strong>Intenta:</strong><br>
                    1. Recargar la p√°gina (F5)<br>
                    2. Usar Chrome/Edge<br>
                    3. Verificar conexi√≥n a internet
                `;
            }
        });
        
        // Limpiar al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            if (camera) {
                camera.stop();
            }
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
    </body>
</html>